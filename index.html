<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zombie Shooter</title>
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
        "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
    }
}
</script>
<style>
    body { margin: 0; overflow: hidden; background: #000; }
    #crosshair { position:absolute; top:50%; left:50%; width:15px; height:15px;
                 border:3px solid #fff; border-radius:50%; transform:translate(-50%,-50%);
                 pointer-events:none; }
</style>
</head>
<body>
<div id="crosshair"></div>
<script type="module">
import * as THREE from 'three';
import { PointerLockControls } from 'three/examples/jsm/controls/PointerLockControls.js';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';

// Scene & Camera
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x333333);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Light
const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
scene.add(ambientLight);
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(5,10,7.5);
scene.add(dirLight);

// Ground
const ground = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color:0x555555}));
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// Controls
const controls = new PointerLockControls(camera, document.body);
document.body.addEventListener('click', ()=>controls.lock());
scene.add(controls.getObject());

// Player
let moveF=false, moveB=false, moveL=false, moveR=false;
const velocity = new THREE.Vector3();
const direction = new THREE.Vector3();
let playerHealth = 100;

// Gun
const gun = new THREE.Group();
gun.position.set(0.5,-0.4,-1);
camera.add(gun);

// Bullets
const bullets = [];
const clip = 1; // one shot per click
let canShoot = true;

// Zombies
const zombies = [];
let waveNumber = 1;
const loader = new GLTFLoader();

// Spawn zombie
function spawnZombie() {
    loader.load('models/zombie/scene.gltf', gltf=>{
        const zombie = gltf.scene;
        zombie.scale.set(1.5,1.5,1.5);
        zombie.position.set(Math.random()*20-10,0,Math.random()*20-10);
        zombie.hp = 100;
        const mixer = new THREE.AnimationMixer(zombie);
        gltf.animations.forEach(clip => mixer.clipAction(clip).play());
        zombie.mixer = mixer;
        scene.add(zombie);
        zombies.push(zombie);
    });
}

// Wave system
function startWave() {
    const zombiesToSpawn = 3 + waveNumber*2;
    let spawned = 0;
    const interval = setInterval(()=>{
        if(spawned<zombiesToSpawn){
            spawnZombie();
            spawned++;
        } else clearInterval(interval);
    },1000);
}
startWave();

// Shoot
document.addEventListener('mousedown', ()=>{
    if(!canShoot) return;
    canShoot=false;
    createBullet();
    setTimeout(()=>{canShoot=true;},150);
});

function createBullet(){
    const geometry = new THREE.SphereGeometry(0.05,8,8);
    const material = new THREE.MeshBasicMaterial({color:0xffff00});
    const bullet = new THREE.Mesh(geometry,material);
    const gunTip = new THREE.Vector3();
    gun.localToWorld(gunTip.set(0,0,0));
    bullet.position.copy(gunTip);
    const velocity = new THREE.Vector3(0,0,-1);
    velocity.applyQuaternion(camera.quaternion);
    bullet.velocity = velocity.multiplyScalar(50);
    scene.add(bullet);
    bullets.push(bullet);
}

// Animate
const clock = new THREE.Clock();
function animate(){
    requestAnimationFrame(animate);
    const delta = clock.getDelta();

    // Move bullets & hit zombies
    bullets.forEach((bullet,i)=>{
        bullet.position.add(bullet.velocity.clone().multiplyScalar(delta));
        zombies.forEach(zombie=>{
            if(bullet.position.distanceTo(zombie.position)<1){
                zombie.hp -= 20; // bullet damage
                if(zombie.hp<=0){
                    scene.remove(zombie);
                    zombies.splice(zombies.indexOf(zombie),1);
                }
                scene.remove(bullet);
                bullets.splice(i,1);
            }
        });
        if(bullet.position.length()>200){scene.remove(bullet); bullets.splice(i,1);}
    });

    // Zombie movement
    const playerPos = controls.getObject().position;
    zombies.forEach(zombie=>{
        zombie.lookAt(playerPos);
        const dist = zombie.position.distanceTo(playerPos);
        if(dist>1.5){
            const moveDir = new THREE.Vector3().subVectors(playerPos,zombie.position).normalize();
            zombie.position.add(moveDir.multiplyScalar(2*delta));
        } else {
            playerHealth -= 5*delta; // zombie damage
            if(playerHealth<=0) alert("YOU DIED");
        }
        if(zombie.mixer) zombie.mixer.update(delta);
    });

    renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
